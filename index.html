<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weather Companion ‚Äî Multi-page SPA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <style>
    html,body,#app{height:100%;}
    .bg-sunny{background:linear-gradient(180deg,#FFEE93,#FFD09A);} 
    .bg-rainy{background:linear-gradient(180deg,#9FC5E8,#5B86E5);} 
    .bg-cloudy{background:linear-gradient(180deg,#D7DDE8,#9EA7C4);} 
    .bg-snow{background:linear-gradient(180deg,#EAF6FF,#CFEFFB);} 
    .bg-night{background:linear-gradient(180deg,#2b2f4a,#0e1726);} 
    .glass{backdrop-filter: blur(6px); background: rgba(255,255,255,0.6);} 
  </style>
</head>
<body class="min-h-screen" id="app">
  <div class="max-w-5xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">üå¶ Weather Companion</h1>
      <nav class="space-x-2">
        <button class="nav-btn px-3 py-1 rounded" data-page="home">Home</button>
        <button class="nav-btn px-3 py-1 rounded" data-page="forecast">Forecast</button>
        <button class="nav-btn px-3 py-1 rounded" data-page="favorites">Favorites</button>
        <button class="nav-btn px-3 py-1 rounded" data-page="lifestyle">Lifestyle</button>
        <button class="nav-btn px-3 py-1 rounded" data-page="settings">Settings</button>
      </nav>
    </header>

    <main class="glass rounded-2xl p-6 shadow">
      <!-- HOME -->
      <section id="page-home" class="page">
        <div class="flex gap-3 mb-4">
          <input id="cityInput" placeholder="Search city (e.g., Lucknow)" class="flex-1 p-3 rounded border" />
          <button id="searchBtn" class="px-4 py-2 rounded bg-blue-600 text-white">Search</button>
          <button id="voiceBtn" class="px-3 py-2 rounded bg-green-600 text-white">üéôÔ∏è</button>
          <button id="saveBtn" class="px-3 py-2 rounded bg-yellow-400">‚òÖ Save</button>
        </div>

        <div id="currentCard" class="p-4 rounded-lg bg-white/80 shadow-sm hidden">
          <div class="flex items-center justify-between">
            <div>
              <div id="cityName" class="text-xl font-semibold">--</div>
              <div id="desc" class="text-sm text-gray-700">--</div>
            </div>
            <div class="text-right">
              <div id="temp" class="text-4xl font-bold">--¬∞C</div>
              <div id="feels" class="text-sm text-gray-600">Feels like --</div>
            </div>
          </div>

          <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
            <div>Humidity: <span id="humidity">--</span>%</div>
            <div>Wind: <span id="wind">--</span> m/s</div>
            <div>AQI: <span id="aqi">--</span></div>
            <div>Score: <span id="score">--</span>/100</div>
          </div>

          <div id="suggestion" class="mt-3 font-medium text-indigo-700">--</div>

          <div class="mt-4 flex gap-2">
            <button id="speakBtn" class="px-3 py-1 rounded bg-indigo-600 text-white">üîä Read</button>
            <button id="shareBtn" class="px-3 py-1 rounded bg-gray-200">Share</button>
            <button id="cacheBtn" class="px-3 py-1 rounded bg-gray-200">Save Offline</button>
          </div>
        </div>

        <div id="homeEmpty" class="text-gray-600">Search a city to see current weather, AQI, and tips.</div>
      </section>

      <!-- FORECAST -->
      <section id="page-forecast" class="page hidden">
        <h2 class="font-semibold mb-3">5-Day Forecast</h2>
        <canvas id="forecastChart" height="120"></canvas>
        <div id="hourlyList" class="mt-4 flex gap-2 overflow-x-auto"></div>
      </section>

      <!-- FAVORITES -->
      <section id="page-favorites" class="page hidden">
        <h2 class="font-semibold mb-3">Favorites</h2>
        <div id="favoritesList" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
      </section>

      <!-- LIFESTYLE -->
      <section id="page-lifestyle" class="page hidden">
        <h2 class="font-semibold mb-3">Lifestyle & Health</h2>
        <div id="lifestyleCard" class="p-4 bg-white/80 rounded">
          <div id="activityRating">Activity Rating: --</div>
          <div id="maskAdvice" class="mt-2">Mask Advice: --</div>
          <div id="sunscreenAdvice" class="mt-2">Sun Advice: --</div>
          <div id="allergyAdvice" class="mt-2">Allergy Advice: --</div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="page-settings" class="page hidden">
        <h2 class="font-semibold mb-3">Settings</h2>
        <div class="space-y-3">
          <div>
            <label class="block text-sm">Temperature Unit</label>
            <select id="unitSelect" class="p-2 border rounded">
              <option value="metric">Celsius (¬∞C)</option>
              <option value="imperial">Fahrenheit (¬∞F)</option>
            </select>
          </div>
          <div>
            <label class="block text-sm">Theme</label>
            <select id="themeSelect" class="p-2 border rounded">
              <option value="auto">Auto</option>
              <option value="day">Day</option>
              <option value="night">Night</option>
            </select>
          </div>
          <div>
            <button id="clearCache" class="px-3 py-2 rounded bg-red-400 text-white">Clear Saved Data</button>
          </div>
        </div>
      </section>

    </main>

    <footer class="mt-4 text-xs text-gray-600">Built with OpenWeatherMap (free API)</footer>
  </div>

<script>
// ===== CONFIG =====
const API_KEY = 'b45aed92194f834fedd73f173228fc9d'; // <-- Replace with your OpenWeatherMap API key
let UNIT = localStorage.getItem('wc_unit') || 'metric';
const THEME = localStorage.getItem('wc_theme') || 'auto';

// ===== State =====
let lastData = null; // {geo, weather, aqi, forecast}
let forecastChart = null;

// ===== Helpers =====
function el(id){return document.getElementById(id);} 
function showPage(p){document.querySelectorAll('.page').forEach(s=>s.classList.add('hidden')); el('page-'+p).classList.remove('hidden');}

function setBackgroundClass(weather){
  const app = document.getElementById('app');
  app.classList.remove('bg-sunny','bg-rainy','bg-cloudy','bg-snow','bg-night');
  if(!weather) return;
  const cond = weather.weather[0].main.toLowerCase();
  const hour = new Date(weather.dt*1000).getHours();
  const isNight = hour<6 || hour>18;
  if(isNight) return app.classList.add('bg-night');
  if(cond.includes('rain')) app.classList.add('bg-rainy');
  else if(cond.includes('cloud')) app.classList.add('bg-cloudy');
  else if(cond.includes('snow')) app.classList.add('bg-snow');
  else app.classList.add('bg-sunny');
}

function kelvinToC(k){return Math.round(k-273.15);} // only if using raw kelvin

function aqiText(score){ if(score==null) return '--'; return ['Good','Fair','Moderate','Poor','Very Poor'][score-1] || score; }

function computeScore(weather, aqi){
  // Simple scoring: temp closeness to 20-25 ideal, lower AQI better, low wind preferable
  const t = weather.main.temp; // in unit selected (if metric it's ¬∞C)
  let tempScore = Math.max(0, 30 - Math.abs(t - 22)) * 3; // roughly 0-60
  if(tempScore>60) tempScore=60;
  const aqiScore = aqi ? (6 - aqi) * 10 : 30; // 1->50,5->10
  const windScore = Math.max(0, 20 - (weather.wind.speed*2));
  const total = Math.round(Math.min(100, tempScore + aqiScore + windScore));
  return total;
}

function saveOffline(geoKey){
  if(!lastData) return; 
  localStorage.setItem('wc_offline_'+geoKey, JSON.stringify(lastData));
  alert('Saved offline. You can view this city even when offline.');
}

function loadFavorites(){
  const favs = JSON.parse(localStorage.getItem('wc_favorites')||'[]');
  el('favoritesList').innerHTML = '';
  favs.forEach(f=>{
    const div = document.createElement('div');
    div.className = 'p-3 bg-white/70 rounded';
    div.innerHTML = `<div class="flex justify-between items-center"><div><strong>${f.name}</strong><div class='text-xs'>${f.country}</div></div><div class='flex gap-2'><button class='px-2 py-1 bg-blue-500 text-white rounded' onclick="loadFromFav('${f.name}')">Open</button><button class='px-2 py-1 bg-red-300 rounded' onclick="removeFav('${f.name}')">Remove</button></div></div>`;
    el('favoritesList').appendChild(div);
  });
}

function addFavorite(){
  if(!lastData) return alert('No city loaded');
  const favs = JSON.parse(localStorage.getItem('wc_favorites')||'[]');
  const name = lastData.geo.name;
  if(favs.find(f=>f.name===name)) return alert('Already saved');
  favs.push({name, country:lastData.geo.country});
  localStorage.setItem('wc_favorites', JSON.stringify(favs));
  loadFavorites();
}

function removeFav(name){
  let favs = JSON.parse(localStorage.getItem('wc_favorites')||'[]');
  favs = favs.filter(f=>f.name!==name);
  localStorage.setItem('wc_favorites', JSON.stringify(favs));
  loadFavorites();
}

function loadFromFav(name){ el('cityInput').value = name; fetchAndRender(name); showPage('home'); }

// ===== Fetching =====
async function geocodeCity(city){
  const url = `https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(city)}&limit=1&appid=${API_KEY}`;
  const res = await fetch(url); const data = await res.json();
  if(!data || !data.length) throw new Error('City not found');
  return {lat:data[0].lat, lon:data[0].lon, name:data[0].name, country:data[0].country};
}

async function fetchWeather(lat, lon){
  const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=${UNIT}&appid=${API_KEY}`;
  const res = await fetch(url); return await res.json();
}

async function fetchForecast(lat, lon){
  const url = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=${UNIT}&appid=${API_KEY}`;
  const res = await fetch(url); return await res.json();
}

async function fetchAQI(lat, lon){
  const url = `https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${API_KEY}`;
  const res = await fetch(url); const d = await res.json(); return (d.list && d.list[0]) ? d.list[0].main.aqi : null;
}

async function fetchAndRender(city){
  try{
    el('homeEmpty').classList.add('hidden');
    el('currentCard').classList.add('hidden');
    el('cityName').textContent = 'Loading...';

    const geo = await geocodeCity(city);
    const weather = await fetchWeather(geo.lat, geo.lon);
    const forecast = await fetchForecast(geo.lat, geo.lon);
    const aqi = await fetchAQI(geo.lat, geo.lon);

    lastData = {geo, weather, forecast, aqi};

    // Update home
    el('cityName').textContent = `${geo.name}, ${geo.country}`;
    el('desc').textContent = weather.weather[0].description;
    el('temp').textContent = Math.round(weather.main.temp) + (UNIT==='metric' ? '¬∞C' : '¬∞F');
    el('feels').textContent = 'Feels like ' + Math.round(weather.main.feels_like) + (UNIT==='metric' ? '¬∞C' : '¬∞F');
    el('humidity').textContent = weather.main.humidity;
    el('wind').textContent = weather.wind.speed;
    el('aqi').textContent = aqiText(aqi);

    const score = computeScore(weather, aqi);
    el('score').textContent = score;

    // Suggestion
    let suggestion = '';
    if(/rain|drizzle|shower/i.test(weather.weather[0].main)) suggestion = 'Carry an umbrella ‚Äî rain likely.';
    else if(weather.main.temp>=30) suggestion = 'Hot day ‚Äî wear light clothes & hydrate.';
    else if(weather.main.temp<=10) suggestion = 'Cold ‚Äî wear warm layers.';
    else suggestion = 'Nice day ‚Äî great for outdoor activities.';
    if(aqi>=4) suggestion += ' Note: Air quality is poor ‚Äî limit outdoor exertion.';
    el('suggestion').textContent = suggestion;

    // Background
    setBackgroundClass(weather);

    // Forecast chart
    renderForecastChart(forecast);
    renderHourly(forecast);

    el('currentCard').classList.remove('hidden');

    // Maybe notify severe conditions
    maybeNotify(weather, aqi, geo.name);

  }catch(err){
    alert(err.message || 'Error fetching data');
  }
}

function renderForecastChart(forecast){
  try{
    const daily = {};
    forecast.list.forEach(it=>{
      const d = new Date(it.dt*1000).toISOString().slice(0,10);
      if(!daily[d]) daily[d]=[];
      daily[d].push(it.main.temp);
    });
    const labels = Object.keys(daily).slice(0,5);
    const temps = labels.map(l=>Math.round(daily[l].reduce((a,b)=>a+b,0)/daily[l].length));
    const ctx = el('forecastChart').getContext('2d');
    if(forecastChart) forecastChart.destroy();
    forecastChart = new Chart(ctx,{type:'line',data:{labels, datasets:[{label:'Avg Temp', data:temps, fill:true, tension:0.4}]}, options:{plugins:{legend:{display:false}}}});
  }catch(e){console.warn(e)}
}

function renderHourly(forecast){
  const list = el('hourlyList'); list.innerHTML='';
  forecast.list.slice(0,12).forEach(it=>{
    const card = document.createElement('div');
    card.className='p-2 bg-white/80 rounded w-36 text-center';
    const dt = new Date(it.dt*1000);
    card.innerHTML = `<div class='text-xs'>${dt.toLocaleString()}</div><div class='text-lg font-bold'>${Math.round(it.main.temp)}${UNIT==='metric'?'¬∞C':'¬∞F'}</div><div class='text-xs'>${it.weather[0].main}</div>`;
    list.appendChild(card);
  });
}

function maybeNotify(weather, aqi, city){
  // Notify heavy rain or very poor AQI
  if(Notification.permission!=='granted') Notification.requestPermission();
  if(/thunder|tornado|squall|extreme/i.test(weather.weather[0].main)){
    if(Notification.permission==='granted') new Notification('Severe Weather', {body:`Severe weather expected in ${city}. Stay safe!`});
  }
  if(aqi>=5 && Notification.permission==='granted') new Notification('Air Quality Alert', {body:`Very poor air quality in ${city}. Avoid outdoor activity.`});
}

// ===== Voice & TTS =====
let recognition = null;
if(window.SpeechRecognition || window.webkitSpeechRecognition){
  const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new Rec(); recognition.lang='en-IN'; recognition.onresult = e=>{ const txt = e.results[0][0].transcript; el('cityInput').value = txt; fetchAndRender(txt); };
}

function speakText(){ if(!lastData) return; const w = lastData.weather; const geo = lastData.geo; const text = `${geo.name} weather: ${Math.round(w.main.temp)} degrees with ${w.weather[0].description}. AQI: ${aqiText(lastData.aqi)}.`; const u = new SpeechSynthesisUtterance(text); window.speechSynthesis.cancel(); window.speechSynthesis.speak(u); }

// ===== Sharing =====
async function shareCurrent(){ if(!lastData) return alert('No data'); const geo = lastData.geo; const score = computeScore(lastData.weather, lastData.aqi); const text = `${geo.name} ‚Äî ${Math.round(lastData.weather.main.temp)}¬∞ (${lastData.weather.weather[0].description}). Weather Score: ${score}/100.`; if(navigator.share){ try{ await navigator.share({title:'Weather Snapshot', text}); }catch(e){ alert('Share cancelled'); } } else { navigator.clipboard.writeText(text); alert('Copied summary to clipboard'); } }

// ===== UI wiring =====
document.querySelectorAll('.nav-btn').forEach(b=>{ b.addEventListener('click', ()=>{ const p=b.dataset.page; showPage(p); if(p==='favorites') loadFavorites(); }); });
el('searchBtn').addEventListener('click', ()=>{ const c = el('cityInput').value.trim(); if(c) fetchAndRender(c); });
el('voiceBtn').addEventListener('click', ()=>{ if(!recognition) return alert('Speech recognition not supported. Use Chrome.'); recognition.start(); });
el('saveBtn').addEventListener('click', addFavorite); el('speakBtn').addEventListener('click', speakText); el('shareBtn').addEventListener('click', shareCurrent); el('cacheBtn').addEventListener('click', ()=>{ if(!lastData) return alert('No city loaded'); saveOffline(lastData.geo.name); });
el('unitSelect').addEventListener('change', e=>{ UNIT = e.target.value; localStorage.setItem('wc_unit', UNIT); if(lastData) fetchAndRender(lastData.geo.name); });
el('themeSelect').addEventListener('change', e=>{ localStorage.setItem('wc_theme', e.target.value); });
el('clearCache').addEventListener('click', ()=>{ localStorage.clear(); alert('Local storage cleared (favorites, offline data, settings).'); location.reload(); });

// Load saved preferences
el('unitSelect').value = UNIT; el('themeSelect').value = THEME;
loadFavorites();

// If API key present, optionally load default
if(API_KEY && API_KEY!=='b45aed92194f834fedd73f173228fc9d'){
  const defaultCity = localStorage.getItem('wc_default_city');
  if(defaultCity) { el('cityInput').value = defaultCity; fetchAndRender(defaultCity); }
}

</script>
</body>
</html>
